# Charcle - Python ファイルエンコーディング変換ツール仕様書

## 1. 概要

Charcleは、ファイルシステム上のテキストファイルの文字エンコーディングを変換するPythonベースのコマンドラインツールです。特にUTF-8以外の文字コードで書かれたファイル（主に日本語テキスト）をUTF-8に変換して「写像」ディレクトリを作成し、AI処理などの後に元のエンコーディングに戻す機能を提供します。

## 2. 主要機能

- ディレクトリツリー全体のファイルエンコーディング変換
- ファイル変更の監視と自動変換（デーモンモード）
- シンボリックリンクの適切な処理
- ファイルシステムメタデータ（権限、所有者、タイムスタンプ）の保持

## 3. サポートするエンコーディング

- UTF-8
- EUC-JP
- Shift-JIS (Windows-31J)
- JIS (ISO-2022-JP)

## 4. コマンドラインインターフェース

```
usage: Charcle [options] [input_dir] [output_dir]
options:
  -f, --from=ENCODING   入力エンコーディングを指定（省略時は自動検出）
  -t, --to=ENCODING     出力エンコーディングを指定（デフォルト: UTF-8）
  -l, --list            サポートするエンコーディングの一覧表示
  -v, --verbose         詳細なログ出力
  --max-size=SIZE       変換するファイルの最大サイズ（例：1M, 500K）
  --exclude=PATTERN     除外するディレクトリやファイルのパターン（カンマ区切り）
  --watch               変更を監視し自動的に書き戻すデーモンモードで実行
  --watch-interval=SEC  監視間隔を秒単位で指定（デフォルト: 1.0）
```

## 5. 詳細仕様

### 5.1 基本動作

1. 入力ディレクトリからファイルを再帰的に読み込む
2. テキストファイルと判断されたファイルについて、エンコーディングを検出または指定されたエンコーディングを使用
3. 目的のエンコーディングに変換してファイルを書き出す
4. 変換不可能なファイルはバイナリとしてそのままコピー

### 5.2 エンコーディング検出と変換

- 入力エンコーディングが指定されていない場合は、`chardet`/`cchardet`を使用して自動検出
- エンコーディング検出の信頼度が低い場合は警告を表示するが処理は継続
- 検出されたエンコーディングがサポート外の場合は、最も近いサポート対象エンコーディングを推測

### 5.3 ファイルサイズ制限

- `--max-size`オプションで指定されたサイズ以上のファイルは変換せずにバイナリコピー
- サイズ指定はK（キロバイト）、M（メガバイト）、G（ギガバイト）の単位で指定可能
- 例：`--max-size=1M`は1メガバイトを意味する

### 5.4 除外設定

- `--exclude`オプションで指定されたパターンに一致するファイルやディレクトリを処理から除外
- カンマ区切りで複数パターンを指定可能
- パターンはシェルのグロブパターン（`*`, `?`, `[...]`）をサポート
- 例：`--exclude=.git,.svn,*.bak,*.tmp`

### 5.5 監視モード

- `--watch`オプションが指定された場合、入力ディレクトリを監視して変更があったファイルを自動的に変換
- 変換先が元のディレクトリよりも新しい場合は逆方向の変換（書き戻し）も実行
- `--watch-interval`オプションで監視間隔を秒単位で指定可能（デフォルト: 1.0秒） できればOSのファイルシステム変更検知の機能を使いたいが、初期実装ではかまわない
- 以下のイベントを監視：
  - ファイルの作成
  - ファイルの変更
  - ファイルの削除
  - ディレクトリの作成
  - ディレクトリの削除

### 5.6 シンボリックリンクの処理

- シンボリックリンクは写像先のパスに適切にマッピング
- リンク先の処理は以下の規則に従う：
  1. 指定したソースディレクトリ内へのリンクの場合：リンク先のパスを写像先の構造に合わせて更新
     - 例：`/path/to/source/link → /path/to/source/file`の場合  
       `/path/to/destination/link → /path/to/destination/file`となる
  2. 指定したソースディレクトリ外へのリンクの場合：リンク先のパスをそのまま維持
     - 例：`/path/to/source/link → /dev/null`の場合  
       `/path/to/destination/link → /dev/null`となる
  3. リンク先がさらにシンボリックリンクの場合：循環参照を防ぐため、そのままのパスを維持

### 5.7 ファイルシステムメタデータの保持

- ファイルとディレクトリの権限（パーミッション）を保持
- ファイルとディレクトリの所有者情報（ユーザー、グループ）を保持
- タイムスタンプ（atime, mtime, ctime）を保持

### 5.8 エラー処理

- エンコーディング検出エラー：警告を表示し、指定されたフォールバックエンコーディングを使用
- 変換エラー：警告を表示し、バイナリファイルとして処理
- I/Oエラー：エラーを表示し、可能な場合は次のファイルの処理を継続
- 中断時の処理：変換中のファイルを破棄し、クリーンアップを実行

### 5.9 ログ出力

- 通常モード：変換された各ファイルの元のエンコーディングと変換先エンコーディングを出力
- 詳細モード（`-v`）：すべてのファイル操作、検出されたエンコーディング、変換の詳細などを表示
- すべてのログは標準出力に出力される

## 6. シャットダウン処理

- 変換中のファイルは破棄
- シグナルハンドリング（SIGINT, SIGTERM）により安全に終了
- 中断された処理は次回起動時に完了しない

## 7. 実装上の考慮事項

### 7.1 パフォーマンス

- 大きなファイルはストリーム処理を使用して効率的に変換
- 監視モードではmtimeベースの最適化により変更があったファイルのみを処理
- 並列処理によるパフォーマンス向上の可能性を検討

### 7.2 エッジケース

- BOMマーカーの適切な処理
- 不完全な文字データの処理
- 非テキストファイルの識別と適切な処理
- リンク先が存在しないシンボリックリンクの扱い

## 8. 使用例

```bash
# 基本的な使用法：ディレクトリをUTF-8に変換
charcle /path/to/source /path/to/destination

# 特定のエンコーディングからUTF-8に変換
charcle --from=SJIS /path/to/source /path/to/destination

# UTF-8からEUC-JPに変換（書き戻し）
charcle --to=EUC-JP /path/to/destination /path/to/source

# 1MB以上のファイルは変換せずにコピー
charcle --max-size=1M /path/to/source /path/to/destination

# 特定のパターンを除外
charcle --exclude=.git,*.bak,*.tmp /path/to/source /path/to/destination

# 変更を監視して自動変換（デーモンモード）
charcle --watch /path/to/source /path/to/destination

# 監視間隔を変更（5秒ごとにチェック）
charcle --watch --watch-interval=5 /path/to/source /path/to/destination

# 詳細なログを出力
charcle --verbose /path/to/source /path/to/destination
```
